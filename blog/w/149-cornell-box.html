<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.53">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <meta property="og:url" content="https://shao.fun/blog/w/149-cornell-box.html"><meta property="og:site_name" content="HK-SHAO"><meta property="og:title" content="149 行代码的康奈尔盒子"><meta property="og:description" content="!Cornell Box Blender (./images/cornell_box_blender.png)!Cornell Box Taichi (./images/cornellboxtaichi.png) :-::-: Cornell Box BlenderCornell Box Taichi| sorry... 抱歉我成了“标题党”，其实 1..."><meta property="og:type" content="article"><meta property="og:image" content="https://shao.fun/"><meta property="og:updated_time" content="2023-01-30T05:49:51.000Z"><meta property="og:locale" content="zh-CN"><meta name="twitter:creator" content="HKSHAO"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="149 行代码的康奈尔盒子"><meta property="article:author" content="HK-SHAO"><meta property="article:modified_time" content="2023-01-30T05:49:51.000Z"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.webmanifest"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ffffff"><meta name="msapplication-TileColor" content="#ffffff"><meta name="theme-color" content="#ffffff"><meta name="keywords" content="烧风, shaofun, hk-shao, hk_shao, HK-SHAO"><meta name="description" content="烧风(HK-SHAO, shaofun)的个人网站/主页，分享一些技术文档/文章和我的作品"><meta name="baidu-site-verification" content="code-9JVoVoLVMg"><title>149 行代码的康奈尔盒子 | HK-SHAO</title>
    <link rel="preload" href="/assets/style.64f441e1.css" as="style" /><link rel="stylesheet" href="/assets/style.64f441e1.css" />
    <link rel="modulepreload" href="/assets/app.d9ef6744.js"><link rel="modulepreload" href="/assets/149-cornell-box.html.5e9acb97.js"><link rel="modulepreload" href="/assets/149-cornell-box.html.14462cf3.js"><link rel="prefetch" href="/assets/LICENSE.html.82b0492a.js" as="script" /><link rel="prefetch" href="/assets/index.html.fa1df886.js" as="script" /><link rel="prefetch" href="/assets/index.html.eb6fb661.js" as="script" /><link rel="prefetch" href="/assets/index.html.33f0646a.js" as="script" /><link rel="prefetch" href="/assets/index.html.c810655d.js" as="script" /><link rel="prefetch" href="/assets/index.html.86588f8b.js" as="script" /><link rel="prefetch" href="/assets/index.html.43963326.js" as="script" /><link rel="prefetch" href="/assets/index.html.08b72ec9.js" as="script" /><link rel="prefetch" href="/assets/license.html.481c976a.js" as="script" /><link rel="prefetch" href="/assets/my-sandbox-game.html.bdc9bc28.js" as="script" /><link rel="prefetch" href="/assets/resume-mind.html.a5d30c4f.js" as="script" /><link rel="prefetch" href="/assets/advanced-use-of-markdown.html.f7675639.js" as="script" /><link rel="prefetch" href="/assets/basic-tutorial-for-markdown.html.6c1cd403.js" as="script" /><link rel="prefetch" href="/assets/how-to-use-markdown.html.884a1e1d.js" as="script" /><link rel="prefetch" href="/assets/labor-demand-based-distribution.html.29d37474.js" as="script" /><link rel="prefetch" href="/assets/taichi-lang-cheatsheet-svg.html.6fbc349b.js" as="script" /><link rel="prefetch" href="/assets/use-echarts-in-markdown.html.dc1e82e3.js" as="script" /><link rel="prefetch" href="/assets/use-mermaid-in-markdwon.html.eaa3a36a.js" as="script" /><link rel="prefetch" href="/assets/20221231DIP.html.34852c83.js" as="script" /><link rel="prefetch" href="/assets/ask-new-bing.html.441cba43.js" as="script" /><link rel="prefetch" href="/assets/english-grammar-summary.html.9de75c63.js" as="script" /><link rel="prefetch" href="/assets/glsl-canvas-and-editor.html.3d3abeb9.js" as="script" /><link rel="prefetch" href="/assets/godot-cube-4d.html.35c06455.js" as="script" /><link rel="prefetch" href="/assets/godot-ray-tracing.html.d58c9aaa.js" as="script" /><link rel="prefetch" href="/assets/godot-smooth-brush.html.ee1c00ea.js" as="script" /><link rel="prefetch" href="/assets/how-diffusion-models-work.html.7e26a92a.js" as="script" /><link rel="prefetch" href="/assets/ray-tracing-denoise.html.698a2220.js" as="script" /><link rel="prefetch" href="/assets/some-godot-tips.html.c532aa44.js" as="script" /><link rel="prefetch" href="/assets/some-math-examples.html.d086b0bf.js" as="script" /><link rel="prefetch" href="/assets/taichi-ray-tracing.html.0f230221.js" as="script" /><link rel="prefetch" href="/assets/index.html.fcec69cc.js" as="script" /><link rel="prefetch" href="/assets/index.html.d389a2de.js" as="script" /><link rel="prefetch" href="/assets/index.html.18082d6b.js" as="script" /><link rel="prefetch" href="/assets/404.html.4272d91a.js" as="script" /><link rel="prefetch" href="/assets/LICENSE.html.100b10f1.js" as="script" /><link rel="prefetch" href="/assets/index.html.920c7810.js" as="script" /><link rel="prefetch" href="/assets/index.html.0fe94629.js" as="script" /><link rel="prefetch" href="/assets/index.html.3051f797.js" as="script" /><link rel="prefetch" href="/assets/index.html.511c0314.js" as="script" /><link rel="prefetch" href="/assets/index.html.8facf8be.js" as="script" /><link rel="prefetch" href="/assets/index.html.e78a5959.js" as="script" /><link rel="prefetch" href="/assets/index.html.351a0b04.js" as="script" /><link rel="prefetch" href="/assets/license.html.e3140cb1.js" as="script" /><link rel="prefetch" href="/assets/my-sandbox-game.html.3a9a6204.js" as="script" /><link rel="prefetch" href="/assets/resume-mind.html.1407f816.js" as="script" /><link rel="prefetch" href="/assets/advanced-use-of-markdown.html.9a2d6427.js" as="script" /><link rel="prefetch" href="/assets/basic-tutorial-for-markdown.html.eb468564.js" as="script" /><link rel="prefetch" href="/assets/how-to-use-markdown.html.fae92592.js" as="script" /><link rel="prefetch" href="/assets/labor-demand-based-distribution.html.7811d1f9.js" as="script" /><link rel="prefetch" href="/assets/taichi-lang-cheatsheet-svg.html.7860c6d6.js" as="script" /><link rel="prefetch" href="/assets/use-echarts-in-markdown.html.b806fb60.js" as="script" /><link rel="prefetch" href="/assets/use-mermaid-in-markdwon.html.e81295a7.js" as="script" /><link rel="prefetch" href="/assets/20221231DIP.html.ed76f6af.js" as="script" /><link rel="prefetch" href="/assets/ask-new-bing.html.1c4bede7.js" as="script" /><link rel="prefetch" href="/assets/english-grammar-summary.html.502f8281.js" as="script" /><link rel="prefetch" href="/assets/glsl-canvas-and-editor.html.ef8f25b8.js" as="script" /><link rel="prefetch" href="/assets/godot-cube-4d.html.d1c58c1f.js" as="script" /><link rel="prefetch" href="/assets/godot-ray-tracing.html.89eaed44.js" as="script" /><link rel="prefetch" href="/assets/godot-smooth-brush.html.86d21e36.js" as="script" /><link rel="prefetch" href="/assets/how-diffusion-models-work.html.20bc7992.js" as="script" /><link rel="prefetch" href="/assets/ray-tracing-denoise.html.6c73261c.js" as="script" /><link rel="prefetch" href="/assets/some-godot-tips.html.d9a1a434.js" as="script" /><link rel="prefetch" href="/assets/some-math-examples.html.8ae0d933.js" as="script" /><link rel="prefetch" href="/assets/taichi-ray-tracing.html.61887167.js" as="script" /><link rel="prefetch" href="/assets/index.html.04f84d58.js" as="script" /><link rel="prefetch" href="/assets/index.html.f386496e.js" as="script" /><link rel="prefetch" href="/assets/index.html.cbfa52ce.js" as="script" /><link rel="prefetch" href="/assets/404.html.dd063ed5.js" as="script" /><link rel="prefetch" href="/assets/index.0e8935cb.js" as="script" /><link rel="prefetch" href="/assets/index.cac02f97.js" as="script" /><link rel="prefetch" href="/assets/flowchart.parse.ee90d7e0.js" as="script" /><link rel="prefetch" href="/assets/mermaid.esm.min.6ea8f3e9.js" as="script" /><link rel="prefetch" href="/assets/mermaid-mindmap.esm.min.401ec564.js" as="script" /><link rel="prefetch" href="/assets/highlight.esm.bbe50b4b.js" as="script" /><link rel="prefetch" href="/assets/markdown.esm.28286a51.js" as="script" /><link rel="prefetch" href="/assets/math.esm.137065e8.js" as="script" /><link rel="prefetch" href="/assets/notes.esm.70909847.js" as="script" /><link rel="prefetch" href="/assets/reveal.esm.dd8bfc4c.js" as="script" /><link rel="prefetch" href="/assets/search.esm.9d0cc719.js" as="script" /><link rel="prefetch" href="/assets/zoom.esm.e108c3af.js" as="script" /><link rel="prefetch" href="/assets/giscus.468808e8.js" as="script" />
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container no-sidebar"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="切换侧边栏" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="/images/logo.png" alt="HK-SHAO"><span class="site-name can-hide">HK-SHAO</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="主页"><!--[--><!--]--> 主页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/" class="router-link-active" aria-label="博文"><!--[--><!--]--> 博文 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/links/" class="" aria-label="链接"><!--[--><!--]--> 链接 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/about/" class="" aria-label="关于"><!--[--><!--]--> 关于 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/HK-SHAO" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="切换颜色模式"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="主页"><!--[--><!--]--> 主页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/" class="router-link-active" aria-label="博文"><!--[--><!--]--> 博文 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/links/" class="" aria-label="链接"><!--[--><!--]--> 链接 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/about/" class="" aria-label="关于"><!--[--><!--]--> 关于 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/HK-SHAO" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><!----><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="_149-行代码的康奈尔盒子" tabindex="-1"><a class="header-anchor" href="#_149-行代码的康奈尔盒子" aria-hidden="true">#</a> 149 行代码的康奈尔盒子</h1><table><thead><tr><th style="text-align:center;"><img src="/assets/cornell_box_blender.b120bd91.png" alt="Cornell Box Blender"></th><th style="text-align:center;"><img src="/assets/cornell_box_taichi.502f5738.png" alt="Cornell Box Taichi"></th></tr></thead><tbody><tr><td style="text-align:center;">Cornell Box Blender</td><td style="text-align:center;">Cornell Box Taichi</td></tr></tbody></table><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> taichi <span class="token keyword">as</span> ti                                                                <span class="token comment"># of course, we need taichi</span>
<span class="token keyword">from</span> taichi<span class="token punctuation">.</span>math <span class="token keyword">import</span> <span class="token operator">*</span>                                                <span class="token comment"># need common mathematical operations</span>

ti<span class="token punctuation">.</span>init<span class="token punctuation">(</span>arch<span class="token operator">=</span>ti<span class="token punctuation">.</span>gpu<span class="token punctuation">,</span> default_ip<span class="token operator">=</span>ti<span class="token punctuation">.</span>i32<span class="token punctuation">,</span> default_fp<span class="token operator">=</span>ti<span class="token punctuation">.</span>f32<span class="token punctuation">)</span>        <span class="token comment"># initialize, use GPU, set default ip and fp</span>

image_resolution <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>                                         <span class="token comment"># resolution of the image, not too large</span>
image_buffer <span class="token operator">=</span> ti<span class="token punctuation">.</span>Vector<span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">,</span> image_resolution<span class="token punctuation">)</span>    <span class="token comment"># image buffer field for recording sample counts</span>
image_pixels <span class="token operator">=</span> ti<span class="token punctuation">.</span>Vector<span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">,</span> image_resolution<span class="token punctuation">)</span>           <span class="token comment"># for output display pixels to the screen</span>

Ray <span class="token operator">=</span> ti<span class="token punctuation">.</span>types<span class="token punctuation">.</span>struct<span class="token punctuation">(</span>origin<span class="token operator">=</span>vec3<span class="token punctuation">,</span> direction<span class="token operator">=</span>vec3<span class="token punctuation">,</span> color<span class="token operator">=</span>vec3<span class="token punctuation">)</span>      <span class="token comment"># the struct representing camera light ray</span>
Material <span class="token operator">=</span> ti<span class="token punctuation">.</span>types<span class="token punctuation">.</span>struct<span class="token punctuation">(</span>albedo<span class="token operator">=</span>vec3<span class="token punctuation">,</span> emission<span class="token operator">=</span>vec3<span class="token punctuation">)</span>             <span class="token comment"># Cornell Box need only albedo and emission</span>
Transform <span class="token operator">=</span> ti<span class="token punctuation">.</span>types<span class="token punctuation">.</span>struct<span class="token punctuation">(</span>position<span class="token operator">=</span>vec3<span class="token punctuation">,</span> rotation<span class="token operator">=</span>vec3<span class="token punctuation">,</span> scale<span class="token operator">=</span>vec3<span class="token punctuation">)</span>          <span class="token comment"># Transformation of SDF objects</span>
SDFObject <span class="token operator">=</span> ti<span class="token punctuation">.</span>types<span class="token punctuation">.</span>struct<span class="token punctuation">(</span>distance<span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>Transform<span class="token punctuation">,</span> material<span class="token operator">=</span>Material<span class="token punctuation">)</span>              <span class="token comment"># SDF objects</span>
HitRecord <span class="token operator">=</span> ti<span class="token punctuation">.</span>types<span class="token punctuation">.</span>struct<span class="token punctuation">(</span><span class="token builtin">object</span><span class="token operator">=</span>SDFObject<span class="token punctuation">,</span> position<span class="token operator">=</span>vec3<span class="token punctuation">,</span> distance<span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> hit<span class="token operator">=</span><span class="token builtin">bool</span><span class="token punctuation">)</span>   <span class="token comment"># for ray-hit-surface</span>

objects    <span class="token operator">=</span> SDFObject<span class="token punctuation">.</span>field<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>                           <span class="token comment"># field for storing SDF objects with 8 objects</span>
objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> SDFObject<span class="token punctuation">(</span>transform<span class="token operator">=</span>Transform<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                material<span class="token operator">=</span>Material<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.4</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                        <span class="token comment"># wall 1</span>
objects<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> SDFObject<span class="token punctuation">(</span>transform<span class="token operator">=</span>Transform<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                material<span class="token operator">=</span>Material<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.4</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                        <span class="token comment"># wall 2</span>
objects<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> SDFObject<span class="token punctuation">(</span>transform<span class="token operator">=</span>Transform<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                material<span class="token operator">=</span>Material<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.4</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                        <span class="token comment"># wall 3</span>
objects<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> SDFObject<span class="token punctuation">(</span>transform<span class="token operator">=</span>Transform<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                material<span class="token operator">=</span>Material<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                        <span class="token comment"># wall 4</span>
objects<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> SDFObject<span class="token punctuation">(</span>transform<span class="token operator">=</span>Transform<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                material<span class="token operator">=</span>Material<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                        <span class="token comment"># wall 5</span>
objects<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> SDFObject<span class="token punctuation">(</span>transform<span class="token operator">=</span>Transform<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.275</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                material<span class="token operator">=</span>Material<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.4</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                    <span class="token comment"># taller box</span>
objects<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> SDFObject<span class="token punctuation">(</span>transform<span class="token operator">=</span>Transform<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">0.275</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">197</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                material<span class="token operator">=</span>Material<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.4</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                           <span class="token comment"># box</span>
objects<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> SDFObject<span class="token punctuation">(</span>transform<span class="token operator">=</span>Transform<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.809</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                material<span class="token operator">=</span>Material<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                         <span class="token comment"># light</span>

<span class="token decorator annotation punctuation">@ti<span class="token punctuation">.</span>func</span>
<span class="token keyword">def</span> <span class="token function">angle</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> vec3<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> mat3<span class="token punctuation">:</span>                                          <span class="token comment"># convert Euler angles to rotation matrix</span>
    s<span class="token punctuation">,</span> c <span class="token operator">=</span> sin<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> cos<span class="token punctuation">(</span>a<span class="token punctuation">)</span>                                          <span class="token comment"># first calculate the two axial projections</span>
    <span class="token keyword">return</span> mat3<span class="token punctuation">(</span>c<span class="token punctuation">.</span>z<span class="token punctuation">,</span> s<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">.</span>z<span class="token punctuation">,</span> c<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> @ \
           mat3<span class="token punctuation">(</span>c<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>y<span class="token punctuation">)</span> @ \
           mat3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>x<span class="token punctuation">,</span> s<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">.</span>x<span class="token punctuation">,</span> c<span class="token punctuation">.</span>x<span class="token punctuation">)</span>      <span class="token comment"># convert to rotation matrix in XYZ and multiply left</span>

<span class="token decorator annotation punctuation">@ti<span class="token punctuation">.</span>func</span>
<span class="token keyword">def</span> <span class="token function">signed_distance</span><span class="token punctuation">(</span>obj<span class="token punctuation">:</span> SDFObject<span class="token punctuation">,</span> pos<span class="token punctuation">:</span> vec3<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>     <span class="token comment"># calc the signed distance from pos to SDF object</span>
    p <span class="token operator">=</span> angle<span class="token punctuation">(</span>radians<span class="token punctuation">(</span>obj<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">)</span> @ <span class="token punctuation">(</span>pos <span class="token operator">-</span> obj<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position<span class="token punctuation">)</span>    <span class="token comment"># translate and then rotate</span>
    q <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> obj<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>scale
    <span class="token keyword">return</span> length<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>y<span class="token punctuation">,</span> q<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>               <span class="token comment"># return the sdf value of the box</span>

<span class="token decorator annotation punctuation">@ti<span class="token punctuation">.</span>func</span>
<span class="token keyword">def</span> <span class="token function">nearest_object</span><span class="token punctuation">(</span>p<span class="token punctuation">:</span> vec3<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> SDFObject<span class="token punctuation">:</span>                                        <span class="token comment"># find the nearest sdf object</span>
    o <span class="token operator">=</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> o<span class="token punctuation">.</span>distance <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>signed_distance<span class="token punctuation">(</span>o<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span>                   <span class="token comment"># we start with the first object</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                                                  <span class="token comment"># for all 8 objects</span>
        oi <span class="token operator">=</span> objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> oi<span class="token punctuation">.</span>distance <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>signed_distance<span class="token punctuation">(</span>oi<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment"># handling the interior of SDF with abs</span>
        <span class="token keyword">if</span> oi<span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> o<span class="token punctuation">.</span>distance<span class="token punctuation">:</span> o <span class="token operator">=</span> oi                  <span class="token comment"># we need the nearest object to step into the ray</span>
    <span class="token keyword">return</span> o                                             <span class="token comment"># this can also be seen as a concatenation of the SDF</span>

<span class="token decorator annotation punctuation">@ti<span class="token punctuation">.</span>func</span>
<span class="token keyword">def</span> <span class="token function">calc_normal</span><span class="token punctuation">(</span>obj<span class="token punctuation">:</span> SDFObject<span class="token punctuation">,</span> p<span class="token punctuation">:</span> vec3<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> vec3<span class="token punctuation">:</span> <span class="token comment"># representing the surface normal by the gradient of the SDF</span>
    e <span class="token operator">=</span> vec2<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5773</span> <span class="token operator">*</span> <span class="token number">0.005</span>                <span class="token comment"># calculation of gradients using the Tetrahedron technique</span>
    <span class="token keyword">return</span> normalize<span class="token punctuation">(</span>e<span class="token punctuation">.</span>xyy <span class="token operator">*</span> signed_distance<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> p <span class="token operator">+</span> e<span class="token punctuation">.</span>xyy<span class="token punctuation">)</span> <span class="token operator">+</span> \
                     e<span class="token punctuation">.</span>yyx <span class="token operator">*</span> signed_distance<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> p <span class="token operator">+</span> e<span class="token punctuation">.</span>yyx<span class="token punctuation">)</span> <span class="token operator">+</span> \
                     e<span class="token punctuation">.</span>yxy <span class="token operator">*</span> signed_distance<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> p <span class="token operator">+</span> e<span class="token punctuation">.</span>yxy<span class="token punctuation">)</span> <span class="token operator">+</span> \
                     e<span class="token punctuation">.</span>xxx <span class="token operator">*</span> signed_distance<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> p <span class="token operator">+</span> e<span class="token punctuation">.</span>xxx<span class="token punctuation">)</span> <span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@ti<span class="token punctuation">.</span>func</span>
<span class="token keyword">def</span> <span class="token function">raycast</span><span class="token punctuation">(</span>ray<span class="token punctuation">:</span> Ray<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> HitRecord<span class="token punctuation">:</span>                 <span class="token comment"># ray marching to obtain the intersection with the surface</span>
    record <span class="token operator">=</span> HitRecord<span class="token punctuation">(</span>distance<span class="token operator">=</span><span class="token number">0.0005</span><span class="token punctuation">)</span>                                  <span class="token comment"># step a little off the surface first</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                                      <span class="token comment"># need a maximum number of steps</span>
        record<span class="token punctuation">.</span>position  <span class="token operator">=</span> ray<span class="token punctuation">.</span>origin <span class="token operator">+</span> record<span class="token punctuation">.</span>distance <span class="token operator">*</span> ray<span class="token punctuation">.</span>direction
        record<span class="token punctuation">.</span><span class="token builtin">object</span>    <span class="token operator">=</span> nearest_object<span class="token punctuation">(</span>record<span class="token punctuation">.</span>position<span class="token punctuation">)</span>    <span class="token comment"># according to the nearest distance ray marching</span>
        record<span class="token punctuation">.</span>distance <span class="token operator">+=</span> record<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>distance                                             <span class="token comment"># sphere tracing</span>
        record<span class="token punctuation">.</span>hit       <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> <span class="token number">0.00001</span>         <span class="token comment"># less than the surface thickness is a hit</span>
        <span class="token keyword">if</span> record<span class="token punctuation">.</span>distance <span class="token operator">&gt;</span> <span class="token number">2000.0</span> <span class="token keyword">or</span> record<span class="token punctuation">.</span>hit<span class="token punctuation">:</span> <span class="token keyword">break</span>                        <span class="token comment"># no need to continue stepping</span>
    <span class="token keyword">return</span> record

<span class="token decorator annotation punctuation">@ti<span class="token punctuation">.</span>func</span>
<span class="token keyword">def</span> <span class="token function">hemispheric_sampling</span><span class="token punctuation">(</span>normal<span class="token punctuation">:</span> vec3<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> vec3<span class="token punctuation">:</span>           <span class="token comment"># choose a random direction in the normal hemisphere</span>
    z <span class="token operator">=</span> <span class="token number">2.0</span> <span class="token operator">*</span> ti<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.0</span>
    a <span class="token operator">=</span> ti<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.0</span> <span class="token operator">*</span> pi
    xy <span class="token operator">=</span> sqrt<span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> z<span class="token operator">*</span>z<span class="token punctuation">)</span> <span class="token operator">*</span> vec2<span class="token punctuation">(</span>sin<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> cos<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> normalize<span class="token punctuation">(</span>normal <span class="token operator">+</span> vec3<span class="token punctuation">(</span>xy<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@ti<span class="token punctuation">.</span>func</span>
<span class="token keyword">def</span> <span class="token function">raytrace</span><span class="token punctuation">(</span>ray<span class="token punctuation">:</span> Ray<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Ray<span class="token punctuation">:</span>                                                                  <span class="token comment"># Path Tracing</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                   <span class="token comment"># 3 times is already enough to bring Global Illumination to the scene</span>
        inv_pdf <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">128.0</span><span class="token punctuation">)</span>
        roulette_prob <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> inv_pdf<span class="token punctuation">)</span>  <span class="token comment"># Russian Roulette for spreading the computation between frames</span>
        <span class="token keyword">if</span> ti<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> roulette_prob<span class="token punctuation">:</span> ray<span class="token punctuation">.</span>color <span class="token operator">*=</span> roulette_prob<span class="token punctuation">;</span> <span class="token keyword">break</span>                     <span class="token comment"># end of tracing</span>

        record <span class="token operator">=</span> raycast<span class="token punctuation">(</span>ray<span class="token punctuation">)</span>                           <span class="token comment"># calculate the intersection of the ray with the scene</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> record<span class="token punctuation">.</span>hit<span class="token punctuation">:</span> ray<span class="token punctuation">.</span>color <span class="token operator">=</span> vec3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span>                           <span class="token comment"># not hitting the light source</span>

        normal  <span class="token operator">=</span> calc_normal<span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span>position<span class="token punctuation">)</span>     <span class="token comment"># calc the normal of the intersection points</span>
        ray<span class="token punctuation">.</span>direction <span class="token operator">=</span> hemispheric_sampling<span class="token punctuation">(</span>normal<span class="token punctuation">)</span>                <span class="token comment"># approximate diffuse reflection direction</span>
        ray<span class="token punctuation">.</span>color <span class="token operator">*=</span> record<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>material<span class="token punctuation">.</span>albedo                  <span class="token comment"># ray needs to be multiplied by the albedo</span>
        ray<span class="token punctuation">.</span>origin <span class="token operator">=</span> record<span class="token punctuation">.</span>position                                         <span class="token comment"># update light departure position</span>

        intensity  <span class="token operator">=</span> dot<span class="token punctuation">(</span>ray<span class="token punctuation">.</span>color<span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">0.299</span><span class="token punctuation">,</span> <span class="token number">0.587</span><span class="token punctuation">,</span> <span class="token number">0.114</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token comment"># calculating the intensity of ray</span>
        ray<span class="token punctuation">.</span>color <span class="token operator">*=</span> record<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>material<span class="token punctuation">.</span>emission                                <span class="token comment"># multiplying the emission</span>
        visible    <span class="token operator">=</span> dot<span class="token punctuation">(</span>ray<span class="token punctuation">.</span>color<span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">0.299</span><span class="token punctuation">,</span> <span class="token number">0.587</span><span class="token punctuation">,</span> <span class="token number">0.114</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                <span class="token comment"># new brightness</span>
        <span class="token keyword">if</span> intensity <span class="token operator">&lt;</span> visible <span class="token keyword">or</span> visible <span class="token operator">&lt;</span> <span class="token number">0.000001</span><span class="token punctuation">:</span> <span class="token keyword">break</span>           <span class="token comment"># too dark or arrive at the light source</span>
    <span class="token keyword">return</span> ray

<span class="token decorator annotation punctuation">@ti<span class="token punctuation">.</span>kernel</span>
<span class="token keyword">def</span> <span class="token function">render</span><span class="token punctuation">(</span>camera_position<span class="token punctuation">:</span> vec3<span class="token punctuation">,</span> camera_lookat<span class="token punctuation">:</span> vec3<span class="token punctuation">,</span> camera_up<span class="token punctuation">:</span> vec3<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> j <span class="token keyword">in</span> image_pixels<span class="token punctuation">:</span>                                         <span class="token comment"># iterate through all pixels in parallel</span>
        <span class="token builtin">buffer</span> <span class="token operator">=</span> image_buffer<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span>                                                     <span class="token comment"># current buffer color</span>

        z <span class="token operator">=</span> normalize<span class="token punctuation">(</span>camera_position <span class="token operator">-</span> camera_lookat<span class="token punctuation">)</span>
        x <span class="token operator">=</span> normalize<span class="token punctuation">(</span>cross<span class="token punctuation">(</span>camera_up<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">)</span>                          <span class="token comment"># calculating the camera coordinate system</span>
        y <span class="token operator">=</span> cross<span class="token punctuation">(</span>z<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
        
        half_width <span class="token operator">=</span> half_height <span class="token operator">=</span> tan<span class="token punctuation">(</span>radians<span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span>           <span class="token comment"># calculate camera frame position and size</span>
        lower_left_corner <span class="token operator">=</span> camera_position <span class="token operator">-</span> half_width <span class="token operator">*</span> x <span class="token operator">-</span> half_height <span class="token operator">*</span> y <span class="token operator">-</span> z
        horizontal <span class="token operator">=</span> <span class="token number">2.0</span> <span class="token operator">*</span> half_width  <span class="token operator">*</span> x
        vertical   <span class="token operator">=</span> <span class="token number">2.0</span> <span class="token operator">*</span> half_height <span class="token operator">*</span> y

        uv <span class="token operator">=</span> <span class="token punctuation">(</span>vec2<span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token operator">+</span> vec2<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ti<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> vec2<span class="token punctuation">(</span>image_resolution<span class="token punctuation">)</span>             <span class="token comment"># oversampling</span>
        po <span class="token operator">=</span> lower_left_corner <span class="token operator">+</span> uv<span class="token punctuation">.</span>x <span class="token operator">*</span> horizontal <span class="token operator">+</span> uv<span class="token punctuation">.</span>y <span class="token operator">*</span> vertical
        rd <span class="token operator">=</span> normalize<span class="token punctuation">(</span>po <span class="token operator">-</span> camera_position<span class="token punctuation">)</span>                          <span class="token comment"># calculation of ray direction by camera</span>

        ray <span class="token operator">=</span> raytrace<span class="token punctuation">(</span>Ray<span class="token punctuation">(</span>camera_position<span class="token punctuation">,</span> rd<span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                       <span class="token comment"># Path Tracing</span>
        <span class="token builtin">buffer</span> <span class="token operator">+=</span> vec4<span class="token punctuation">(</span>ray<span class="token punctuation">.</span>color<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>              <span class="token comment"># accumulate colors and record the number of accumulations</span>
        image_buffer<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">buffer</span>                                                      <span class="token comment"># updating the buffer</span>

        color <span class="token operator">=</span> <span class="token builtin">buffer</span><span class="token punctuation">.</span>rgb <span class="token operator">/</span> <span class="token builtin">buffer</span><span class="token punctuation">.</span>a                                  <span class="token comment"># calculate the average value of colors</span>
        color <span class="token operator">=</span> <span class="token builtin">pow</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">2.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                     <span class="token comment"># Gamma correction, then use ACES tone mapping</span>
        color <span class="token operator">=</span> mat3<span class="token punctuation">(</span><span class="token number">0.597190</span><span class="token punctuation">,</span> <span class="token number">0.35458</span><span class="token punctuation">,</span> <span class="token number">0.04823</span><span class="token punctuation">,</span> <span class="token number">0.07600</span><span class="token punctuation">,</span> <span class="token number">0.90834</span><span class="token punctuation">,</span> <span class="token number">0.01566</span><span class="token punctuation">,</span> <span class="token number">0.02840</span><span class="token punctuation">,</span> <span class="token number">0.13383</span><span class="token punctuation">,</span> <span class="token number">0.83777</span><span class="token punctuation">)</span> @ color
        color <span class="token operator">=</span> <span class="token punctuation">(</span>color <span class="token operator">*</span> <span class="token punctuation">(</span>color <span class="token operator">+</span> <span class="token number">0.024578</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0.0000905</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>color <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0.983729</span> <span class="token operator">*</span> color <span class="token operator">+</span> <span class="token number">0.4329510</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.238081</span><span class="token punctuation">)</span>
        color <span class="token operator">=</span> mat3<span class="token punctuation">(</span><span class="token number">1.60475</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.531</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.0736</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.102</span><span class="token punctuation">,</span> <span class="token number">1.10813</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.00605</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.00327</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.07276</span><span class="token punctuation">,</span> <span class="token number">1.07602</span><span class="token punctuation">)</span> @ color
        image_pixels<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> clamp<span class="token punctuation">(</span>color<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># write pixels, clamp the brightness that cannot be displayed</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    window <span class="token operator">=</span> ti<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>Window<span class="token punctuation">(</span><span class="token string">&quot;Cornell Box&quot;</span><span class="token punctuation">,</span> image_resolution<span class="token punctuation">)</span>                                     <span class="token comment"># create window</span>
    canvas <span class="token operator">=</span> window<span class="token punctuation">.</span>get_canvas<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> window<span class="token punctuation">.</span>running<span class="token punctuation">:</span>                                                            <span class="token comment"># main loop of the window</span>
        render<span class="token punctuation">(</span>vec3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment"># set the camera parameters, then render</span>
        canvas<span class="token punctuation">.</span>set_image<span class="token punctuation">(</span>image_pixels<span class="token punctuation">)</span>                                              <span class="token comment"># writing pixels to canvas</span>
        window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>                                                                <span class="token comment"># continue to show window</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>                                                                             <span class="token comment"># By HK-SHAO 2023/01/30</span>
<span class="token comment"># ------------------------------------------------------------------------------------------------------------</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container warning"><p class="custom-container-title">sorry...</p><ul><li>抱歉我成了“标题党”，其实 139 行就够了</li></ul></div><div class="custom-container info"><p class="custom-container-title">相关信息</p><ul><li><a href="https://github.com/HK-SHAO/RayTracingPBR" target="_blank" rel="noopener noreferrer">https://github.com/HK-SHAO/RayTracingPBR<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span></a></li></ul></div></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/HK-SHAO/HK-SHAO.github.io/edit/main/src/blog/w/149-cornell-box.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页"><!--[--><!--]--> 在 GitHub 上编辑此页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: hk-shao@foxmail.com">HK-SHAO</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--[--><div class="giscus-wrapper input-top" style="display:block;"><div style="text-align:center">Loading...</div></div><!--]--><!--]--></main><!--]--></div><!----><!----><!--]--></div>
    <script type="module" src="/assets/app.d9ef6744.js" defer></script>
  </body>
</html>
